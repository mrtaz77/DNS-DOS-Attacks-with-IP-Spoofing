# Production - Full security, high availability
version: '3.8'

services:
  redis:
    image: redis:7-alpine
    container_name: dns-redis-prod
    ports:
      - "6379:6379"
    volumes:
      - redis_prod_data:/data
    command: >
      redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-dnsserver2024}
    restart: unless-stopped

  dns-primary-prod:
    build: .
    container_name: dns-primary-prod
    ports:
      - "15353:15353/udp"
      - "15354:15354/tcp"
      - "853:853/tcp"
    environment:
      - DNS_MODE=production
      - REDIS_PASSWORD=${REDIS_PASSWORD:-dnsserver2024}
    command: >
      --zone /app/dns_server/zones/primary.zone
      --addr 0.0.0.0
      --port-udp 15353
      --port-tcp 15354
      --forwarder 1.1.1.1
      --cache-type hybrid --cache-size 50000
      --redis-url redis://:${REDIS_PASSWORD}@redis:6379/0
      --tsig-name tsig-key-1752130646
      --tsig-secret 2vgKc8+OH9UMBrRYTBYOmjffLACFVtGQPgXjt6fw05k=
      --rate-limit-threshold 100
      --rate-limit-window 10
    depends_on:
      - redis
    volumes:
      - ./dns_server/zones:/app/dns_server/zones:ro
      - ./dns_server/certs:/app/dns_server/certs:ro
      - ./dns_server/keys:/app/keys:ro
      - ./logs:/app/logs
    restart: unless-stopped

  dns-secondary-prod:
    build: .
    container_name: dns-secondary-prod
    ports:
      - "17353:17353/udp"
      - "17354:17354/tcp"
    environment:
      - DNS_MODE=production
      - REDIS_PASSWORD=${REDIS_PASSWORD:-dnsserver2024}
    command: >
      --zone /app/dns_server/zones/secondary.zone
      --addr 0.0.0.0
      --port-udp 17353
      --port-tcp 17354
      --secondary
      --primary-server dns-primary-prod
      --primary-port 15354
      --refresh-interval 60
      --forwarder 1.1.1.1
      --cache-type hybrid --cache-size 50000
      --redis-url redis://:${REDIS_PASSWORD}@redis:6379/1
      --tsig-name tsig-key-1752130646
      --tsig-secret 2vgKc8+OH9UMBrRYTBYOmjffLACFVtGQPgXjt6fw05k=
      --rate-limit-threshold 100
      --rate-limit-window 10
    depends_on:
      - redis
      - dns-primary-prod
    volumes:
      - ./dns_server/zones:/app/dns_server/zones
      - ./dns_server/certs:/app/dns_server/certs:ro
      - ./dns_server/keys:/app/keys:ro
      - ./logs:/app/logs
    restart: unless-stopped

volumes:
  redis_prod_data:
    driver: local
